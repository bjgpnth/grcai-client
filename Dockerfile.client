# gRCAi Client Runtime Dockerfile
# 
# This Dockerfile builds the CLIENT runtime image only.
# It explicitly EXCLUDES all Central/IP-protected components:
#   - llm/llm_reasoner.py
#   - llm/evidence_reducer.py
#   - llm/token_estimator.py
#   - prompts/ directory
#   - central_service/ directory
#
# Build: docker build -f Dockerfile.client -t grcai/client:latest .
# Usage: See docs/deployment.md for deployment instructions

FROM python:3.12-slim

# Metadata labels for container identification
LABEL org.opencontainers.image.title="gRCAi Client Runtime"
LABEL org.opencontainers.image.description="Client runtime for gRCAi - excludes all IP-protected reasoning components"
LABEL org.opencontainers.image.vendor="gRCAi"
LABEL org.opencontainers.image.component="client"
LABEL org.opencontainers.image.architecture="amd64"

WORKDIR /grcai

# Install lightweight process and network tools for diagnostics
# curl is required for health checks
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        procps \
        net-tools \
        curl \
        iputils-ping \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Copy requirements and install dependencies
# Note: requests library is needed for RCAClient HTTP calls
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy CLIENT components only (explicitly exclude Central/IP components)
# Copy root level files
COPY main.py .
COPY __version__.py .

# Copy client code
COPY client/ ./client/

# Copy connectors (execution only, no reasoning)
COPY connectors/ ./connectors/

# Copy orchestrator (collection orchestration, no reasoning)
COPY orchestrator/ ./orchestrator/

# Copy evidence store (local storage)
COPY evidence_store/ ./evidence_store/

# Copy UI (local UI)
COPY ui/ ./ui/

# Copy config (configuration loading, no reasoning logic)
COPY config/ ./config/

# Copy utils (utility functions)
COPY utils/ ./utils/

# CRITICAL: Do NOT copy:
#   - llm/ directory (contains reasoning logic)
#   - prompts/ directory (contains prompt engineering)
#   - central_service/ directory (Central service code)

# Create non-root user for security (Azure best practice)
RUN useradd -m -u 1000 grcai && \
    chown -R grcai:grcai /grcai

# Set environment variables
# Force remote mode in client image (IP components excluded)
ENV PYTHONUNBUFFERED=1
ENV GRCAI_REASONING_MODE=remote
# Default Central URL, override via environment
ENV GRCAI_CENTRAL_URL=http://central:8000
ENV STREAMLIT_SERVER_PORT=8501
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
ENV STREAMLIT_SERVER_HEADLESS=true
ENV STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# Expose UI port (Streamlit default)
EXPOSE 8501

# Health check for Azure Container Instances / Kubernetes
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# Switch to non-root user
USER grcai

# Default command (can be overridden)
# For UI: streamlit run ui/app.py --server.port=8501 --server.address=0.0.0.0
# For CLI: python main.py collect --environment qa --components os,tomcat
CMD ["python", "main.py", "--help"]

